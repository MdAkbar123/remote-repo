---
- name: Deploy Node.js Application
  hosts: all
  become: yes
  vars:
    app_dir: /home/ubuntu/node-service
    repo_url: "git@github.com:MdAkbar123/remote-repo.git"
    start_command: "/usr/bin/node server.js"
    service_name: node-service
    node_port: 3000  # use non-privileged port

  tasks:
    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        mode: "0755"

    - name: Clone repository into node-service
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_dir }}"
        version: main
        force: yes
      become_user: ubuntu

    - name: Debug cloned directory
      command: ls -l {{ app_dir }}/app
      register: list_output
      ignore_errors: yes

    - debug:
        var: list_output.stdout_lines

    - name: Install Node.js dependencies
      npm:
        path: "{{ app_dir }}/app"
        production: yes
      become: yes
      become_user: ubuntu

    - name: Stop existing Node.js process (if running)
      shell: pkill node || true
      ignore_errors: yes

    - name: Create systemd service for Node app
      copy:
        dest: "/etc/systemd/system/{{ service_name }}.service"
        content: |
          [Unit]
          Description=Node.js Application
          After=network.target

          [Service]
          ExecStart={{ start_command }}
          WorkingDirectory={{ app_dir }}/app
          Restart=always
          User=ubuntu
          Environment=PORT={{ node_port }}
          StandardOutput=append:/var/log/node-service.log
          StandardError=append:/var/log/node-service-error.log

          [Install]
          WantedBy=multi-user.target
      notify: Restart Node app

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Node.js app as service
      systemd:
        name: "{{ service_name }}"
        enabled: yes
        state: started

  handlers:
    - name: Restart Node app
      systemd:
        name: "{{ service_name }}"
        state: restarted
