name: Deploy Node Service

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add SSH key to agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}


      - name: Deploy via SSH (native ssh)
        run: |
          set -e
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} '
            set -e
            cd /home/ubuntu

            # If directory exists but not a valid Git repo, delete it
            if [ -d "node-service" ] && [ ! -d "node-service/.git" ]; then
              echo "âš ï¸ Found corrupted or non-git directory. Cleaning up..."
              rm -rf node-service
            fi

            # Clone repo if not present
            if [ ! -d "node-service" ]; then
              echo "ðŸ“¦ Cloning repository for the first time..."
              git clone git@github.com:${{ github.repository }} node-service
            fi

            cd node-service

            echo "ðŸ§© Fixing ownership and permissions..."
            sudo chown -R ubuntu:ubuntu /home/ubuntu/node-service
            git config --global --add safe.directory /home/ubuntu/node-service

            echo "ðŸ”„ Updating repository..."
            git fetch --all
            git reset --hard origin/main

            echo "ðŸ“¦ Installing dependencies..."
            npm ci --omit=dev

            echo "ðŸš€ Restarting Node.js service..."
            sudo pkill node || true
            nohup npm start > app.log 2>&1 &

            echo "âœ… Deployment completed successfully!"
          '
